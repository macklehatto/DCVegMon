---
title: "Vegetation Monitoring Analysis"
author: "Manhatton"
date: "2/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##install packages
#install.packages('skimr', repos = "http://cran.us.r-project.org")
#install.packages('kableExtra', repos = "http://cran.us.r-project.org")
#install.packages('janitor', repos = "http://cran.us.r-project.org")

## attach libraries
library(tidyverse)
library(readxl)
library(janitor)
library(dplyr)
library(here)

library(skimr)  
library(kableExtra)  


## Change this to the filepath for the data directory

directory <- "C:\\Users\\Meg\\OneDrive - University of Nebraska-Lincoln\\R practice\\DCVegMon\\data\\"

##Find all releve xlsx within directory

file.list <- list.files(directory, pattern = '*.xlsx', full.names = TRUE)

## Extract data from woody, forbs and grasses worksheets

 extract_data <- function(x)
{
woody <- read_xlsx(x, sheet = "Woody", skip = 8)%>%
  janitor::clean_names() %>%
  janitor::remove_empty(c("rows"))%>%
  mutate(rarity_status = as.character(rarity_status)) %>%
  select("scientific_name", "common_name", "x3" , "physiognamy", "mn_nativity", "mnwi", "rarity_status" = , "id" , "cc" , "cc_range", "x12" , "midpoint_cc", "p", "p_c")

forbs <- read_xlsx(x, sheet = "Forbs", skip = 8)%>%
 janitor::clean_names() %>%
 janitor::remove_empty(c("rows"))%>%
 mutate(rarity_status = as.character(rarity_status))  %>%
 select("scientific_name", "common_name", "x3" , "physiognamy", "mn_nativity", "mnwi", "rarity_status" = , "id" , "cc" , "cc_range", "x12" , "midpoint_cc", "p", "p_c")
  
grasses <- read_xlsx(x, sheet = "Grasses", skip = 8)%>%
  janitor::clean_names() %>%
  janitor::remove_empty(c("rows"))%>%
  mutate(rarity_status = as.character(rarity_status)) %>%
  select("scientific_name", "common_name", "x3" , "physiognamy", "mn_nativity", "mnwi", "rarity_status" = , "id" , "cc" , "cc_range", "x12" , "midpoint_cc", "p", "p_c")

relevecode <- read_xlsx(x, sheet = "Woody", range = "C2:C2", col_names = FALSE) #grabs the relevecode from C2 of Woody sheet

 data_frame <- (bind_rows(woody, forbs, grasses)) #combine the woody, forbs, and grasses data rows

 data_frame['releveCode'] <- list(relevecode[[1,1]]) #assign value from woody cell C2 to new column in combined dataframe (indicates releve code)
  
  return(data_frame)
}

 ##create empty dataframe with all the required columns
 
all_df <- data.frame("scientific_name"=character(), "common_name"=character(), "x3" =numeric(), "physiognamy"=character(), "mn_nativity" = character(), "mnwi"= character(), "rarity_status" = character(), "id" = character(), "cc" = numeric(), "cc_range" = character(), "x12" = numeric(), "midpoint_cc"= numeric(), "p" = numeric(), "p_c" = numeric(), releveCode = character()) 

##loop through all files in the folder 

for (x in file.list){
  print(x)
  single_df <- extract_data(x)
  all_df <- rbind(all_df, single_df)
}

##removes all rows with greater than 10 "NA" cells 

hi <- apply(all_df, 1, function(x) sum(is.na(x)))
all_df <- all_df[hi<10,]

##create new dataframe with just the scientific name, midpoint % cover, releve 

#ordination_df <- 

```



```{r fileindex, include=FALSE}

## ----------------- CREATE INDEX FILE  ----------------------

library(dplyr)

filepath <- "C:\\Users\\Meg\\OneDrive - University of Nebraska-Lincoln\\R practice\\DCVegMon\\data\\"

file.list <- list.files(filepath, pattern = '*.xlsx', full.names = TRUE) 

extract_data <- function(x)
{
relevecode <- read_xlsx(x, sheet = "Woody", range = "C2:C2", col_names = FALSE, na="")  

## Save this rabbit hole for later. Blank cells don't exist in Excel, and R will only provide the Index File for files that have all cells. Not sure at which step this is happening - in read or during the bind? 
#relevename <- read_xlsx(x, sheet = "Woody", range ="B2:B2", col_names = FALSE, na="")
#relevedate <- read_xlsx(x, sheet = "Woody", range = "B5:B5", col_names = FALSE, na="")

df <- x 

df <- bind_cols(df, relevecode)#, relevename, relevedate)

return(df)
}

IndexFile <- data.frame("file"= character(), "releve code" = character(), "releve name" = character(), "releve date" = character())

for (x in file.list){
  single_file2 <- extract_data(x)
  IndexFile <- rbind(IndexFile, single_file2)
}

## Compare the Index File to the releve codes that have been imported from excel. Report missing files
All <-unique(all_df$releveCode)
Index <- unique(IndexFile$...2)
Missing <- Index[!(Index %in% All)]

print(Missing)
#print(IndexFile)

```

## OH NOS!
The following releves have issues. Check for blank/missing data in the observations worksheets.

```{r uhoh , echo=false}
print(Missing)
```
## Project To Do:

*xread 2020 and 2021 releve data
*-read GRG reference (ordination folder)
*-Table: Releve, Species, Midpoint % Cover (column M)
*-For our data: Need to add name column to each - in C2 of Woody tab - add column (2020, 2021)
*-For GRG data: the name will be in the NPC Code
*-Pull in the Compiled Releve Data for R, sheet1 - add year column
*-Create matrix


```{r df}


```

